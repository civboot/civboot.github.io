<head>
  <meta charset="utf-8">
  <title>Civboot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../styles.css">
</head>
<nav>
  <ul>
    <a href="../index.html"   class="nav"             >civ/</a>
    <a href="index.html"      class="nav nav-selected">lua/</a>
  </ul>
</nav>

<!DOCTYPE html>
<html>
<body><div class=doc>
<h1><a id="civ_build_system_and_pkg_manager" href="#civ_build_system_and_pkg_manager">civ build system and pkg manager</h1></a>
Civstack is a full developer tech stack, and the bedrock of that is the build
system -- which is this package (<span class=code>civ</span>).
<p>
A "build system" is fundamentally a mechanism to convert a set of files and
configuration (a package) into a runnable (and testable) software. A package
manager is then a way to upload and depend on other packages.
<p>
A <i>good</i> build system has two other primary features: <ul>
  <li>ergonomics: package specification is complete and easy to both read and write.</li>
  <li>hermetic: each built component <i>can</i> be isolated from the rest of the system
  and deterministically built.</li>
</ul>
<p>
<h3><a id="PKG.lua" href="#PKG.lua">PKG.lua</h3></a>
The <span class=code>PKG.lua</span> file is is how you specify how to build a package and what is
exported from that package. Below is an example one which we will walk though.
Before we do, a few notes:
<ul>
  <li>This file is 100% pure lua except with different builtin globals.</li>
  <li>Noteablly none of lua's builtins are available, and instead there are several
  functions for importing luk files (which we will get to).</li>
</ul>
<p>
Example <span class=code>PKG.lua</span>:
<div class=code-block>local P = { summary = "Does foo and some bar" }<br>
<br>
--- Imports a function to help us create Target<br>
local cc &nbsp;= import'sys:cc.luk' &nbsp;-- C build targets<br>
local lua = import'sys:lua.luk' -- Lua build targets<br>
<br>
-- Set up metadata for this PKG.lua file, this must be<br>
-- returned at the end with the targets and PoD to provide<br>
-- clients.<br>
--<br>
-- This also creates the global `P` value, which is the data<br>
-- (build information) exported by this file.<br>
P.foo = lua {<br>
&nbsp; mod = 'foo',<br>
&nbsp; dep = {<br>
&nbsp; &nbsp; 'civ:lib',<br>
&nbsp; &nbsp; 'myhub:foo#libfoo', &nbsp;-- the next target<br>
&nbsp; },<br>
}<br>
<br>
-- test rule<br>
P.test = lua.test {<br>
&nbsp; src = 'test.lua',<br>
&nbsp; dep = { 'myhub:foo',<br>
}<br>
<br>
-- C build target<br>
P.libfoo = cc {<br>
&nbsp; hdr = { 'foo.h' },<br>
&nbsp; src = { 'foo.c' },<br>
&nbsp; dep = {<br>
&nbsp; &nbsp; 'myhub:bar#libbar',<br>
&nbsp; },<br>
}<br>
<br>
return P
</div>
<p>
<div class=info>Every value assigned to <span class=code>P</span> must be either a concrete type or a
<a href="#pvc.Target">#pvc.Target</a>.
</div>
<p>
<h3><a id="civ-out" href="#civ-out">civ output directory</h3></a>
By default, <span class=code>civ build</span> puts files in <span class=code>.out/civ/</span>. Wherever it puts it's output
(whether during build or installation), the output structure under that directory
is as follows: <ul>
  <li><span class=code>bin/</span>: executable binaries/scripts segregated by pkg, i.e.
  <span class=code>bin/pkgname_foo</span>. Also contains soft-links for binaries with unique names
  to conform with <span class=code>PATH</span>, i.e. <span class=code>bin/foo</span>.</li>
  <li><span class=code>lua/</span>: contains all <span class=code>mod.lua</span> files, and the sub-module files under
  <span class=code>mod/sub.lua</span>. This conforms with
  <a href="https://www.lua.org/manual/5.4/manual.html#pdf-package.searchpath">package.searchpath</a>,
  which allows the normal lua loader to load these packages with <span class=code>LUA_PATH</span>
  set to <span class=code>.../civ/lua/</span>.</li>
  <li><span class=code>data/</span>: contains arbitrary data files defined by targets.</li>
  <li><span class=code>lib/</span>: all library files in a flat directory, all of which must start with
  <span class=code>lib</span> i.e. <span class=code>libfoo.so</span>. This is to conform with the envornment variables
  <span class=code>LUA_CPATH, LD_LIBRARY_PATH</span>, etc as well as the <span class=code>cc -l</span> flag.</li>
  <li><span class=code>include/</span>: header files, both <span class=code>.h</span> and <span class=code>.iH</span> (iA header) for linking
  dynamic libraries during compilation.</li>
  <li><span class=code>log/</span>: contains metadata about what each target installed, i.e. <span class=code>log/mypkg/foo.files</span> used
  by the build system for incremental builds as well as by installation system to remove
  files during uninstall.</li>
</ul>
<p>
<p>
<h1><a id=""civ"" href="#"civ"">civ</h1></a>
The civ build system command.
<p>
<b>Types</b> <ul>
  <li><b>civ.Init</b></li>
  <li><b>civ.Base</b></li>
  <li><b>civ.Build</b></li>
  <li><b>civ.Test</b></li>
  <li><b>civ.Run</b></li>
  <li><b>civ.Install</b></li>
</ul>
<p>
<b>Functions</b> <ul>
  <li><span class=code>build(cv, tgtnames)</span></li>
  <li><span class=code>test(cv, tgtnames)</span></li>
  <li><span class=code>main(args)</span></li>
</ul>
<p>
<h2><a id=""civ.Init"" href="#"civ.Init"">Record Init</h2></a>
<ul>
  <li><b>out</b> :
  path to output config.lua</li>
  <li><b>base</b> :
  base config to copy from</li>
</ul>
civ init arguments.
<p>
<h2><a id=""civ.Base"" href="#"civ.Base"">Record Base</h2></a>
<ul>
  <li><b>config</b> :
  path to civ config.</li>
</ul>
<p>
<h2><a id=""civ.Build"" href="#"civ.Build"">Record Build</h2></a>
<ul>
  <li><b>config</b> :
  path to civ config.</li>
</ul>
Usage: <span class=code>civ build hub:tgt#name</span>
<p>
<h2><a id=""civ.Test"" href="#"civ.Test"">Record Test</h2></a>
<ul>
  <li><b>config</b> :
  path to civ config.</li>
</ul>
Usage: <span class=code>civ test hub:tgt#name</span>
<p>
<h2><a id=""civ.Run"" href="#"civ.Run"">Record Run</h2></a>
<ul>
  <li><b>config</b> :
  path to civ config.</li>
</ul>
Usage: <span class=code>civ run hub:tgt#name -- ...args</span>
Build+run a single build target which has a single bin output.
<p>
<h2><a id=""civ.Install"" href="#"civ.Install"">Record Install</h2></a>
<ul>
  <li><b>config</b> :
  path to civ config.</li>
  <li><b>force</b> :
  do not confirm deletion of files.</li>
</ul>
Usage: <span class=code>civ install hub:tgt#name</span>
<p>
<h1><a id=""civ.core"" href="#"civ.core"">civ.core</h1></a>
Core civ (build system) types and functions.
<p>
<b>Types</b> <ul>
  <li><b>civ.core.TargetName</b></li>
  <li><b>civ.core.Target</b></li>
  <li><b>civ.core.CfgBuilder</b></li>
  <li><b>civ.core.Cfg</b></li>
  <li><b>civ.core.Civ</b></li>
</ul>
<p>
<b>Functions</b> <ul>
  <li><span class=code>tgtnameSplit()</span></li>
  <li><span class=code>tgtname(tgtname)</span></li>
</ul>
<p>
<h2><a id=""civ.core.TargetName"" href="#"civ.core.TargetName"">Record TargetName</h2></a>
<ul>
  <li><b>pkgname</b> </li>
  <li><b>name</b> </li>
</ul>
Represents a pkgname.target parsed from a string
<p>
<h2><a id=""civ.core.Target"" href="#"civ.core.Target"">Record Target</h2></a>
<ul>
  <li><b>pkgname</b> :
  name of package target is in.</li>
  <li><b>name</b> :
  the name of the target.</li>
  <li><b>kind</b> :
  the kind of target: build, test, executable</li>
  <li><b>dir</b> :
  directory of src files</li>
  <li><b>src</b> :
  list of input source files (strings).</li>
  <li><b>dep</b> :
  list of input Target objects (dependencies).</li>
  <li><b>extra</b> :
  arbitrary value, used by run command</li>
  <li><b>api</b> :
  the lang-specific exported import paths.</li>
  <li><b>depIds</b> :
  list of dependency target ids. Populated for Worker.</li>
  <li><b>out</b> :
  POD table output segregated by language.<ul>
    <li>t: PoD in a k/v table, can be used to configure downstream targets.</li>
    <li>data: list of raw files.</li>
    <li>include: header file paths for native code (C/iA).</li>
    <li>lib: dynamic library files (i.e. libfoo.so)</li>
    <li>bin: executable binaries</li>
    <li>lua: lua files</li>
  </ul></li>
  <li><b>link</b> :
  link outputs from -> to</li>
  <li><b>tag</b> :
  arbitrary attributes like test, testonly, etc.</li>
  <li><b>ENV</b> :
  the environment that scripts run in.</li>
  <li><b>run</b> :
  executable script which performs the operation kind.</li>
</ul>
A build target, the result of compiling a package.
<p>
<h2><a id=""civ.core.CfgBuilder"" href="#"civ.core.CfgBuilder"">Record CfgBuilder</h2></a>
<ul>
  <li><b>direct</b> :
  prefer building directly
  (running build scripts w/ dofile).</li>
</ul>
<p>
<h2><a id=""civ.core.Cfg"" href="#"civ.core.Cfg"">Record Cfg</h2></a>
<ul>
  <li><b>path</b> :
  the path to this config file.</li>
  <li><b>host_os</b> :
  the operating system of this computer.'
  Typically equal to civix.OS</li>
  <li><b>hubs</b> :
  table of hubname -> /absolute/dir/path</li>
  <li><b>buildDir</b> :
  directory to put build/test files.</li>
  <li><b>installDir</b> :
  directory to install files to.</li>
  <li><b>builder</b> :
  builder settings</li>
</ul>
The user configuration, typically at ./.civconfig.lua
<p>
<h2><a id=""civ.core.Civ"" href="#"civ.core.Civ"">Record Civ</h2></a>
<ul>
  <li><b>cfg</b> :
  the user config</li>
  <li><b>hubs</b> :
  table of hub -> dir (cfg.hubs)</li>
  <li><b>pkgs</b> :
  table of pkgname -> pkg</li>
  <li><b>luk</b> </li>
  <li><b>cycle</b> </li>
  <li><b>worker</b> :
  direct worker</li>
  <li><b>ENV</b> :
  environment for running workers</li>
</ul>
Holds top-level data structures and algorithms for
processing civ build graphs (pkgname graphs).
<p>
<h1><a id=""Ty<civ.Worker>"" href="#"Ty<civ.Worker>"">Record civ.Worker</h1></a>
<ul>
  <li><b>ids</b> :
  the target ids to work on.</li>
  <li><b>cfg</b> </li>
  <li><b>tgtsDb</b> :
  indexed line-file of targets by id</li>
  <li><b>tgtsCache</b> :
  already loaded targets</li>
</ul>
<p>
</div></body>
</html>
