<head>
  <meta charset="utf-8">
  <title>Civboot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../styles.css">
</head>
<nav>
  <ul>
    <a href="../index.html"   class="nav"             >civ/</a>
    <a href="index.html"      class="nav nav-selected">lua/</a>
  </ul>
</nav>

<!DOCTYPE html>
<html>
<body><div class=doc>
<h3><a id="vcds" href="#vcds" class=anchor>Mod vcds</h3></a>
vsds: version control data structures (and algorithms)
<br>
<b>Types: </b><a href="#vcds.Diff">Diff</a> <a href="#vcds.Keep">Keep</a> <a href="#vcds.Change">Change</a> <a href="#vcds.DiffsExtender">DiffsExtender</a> <a href="#vcds.Picks">Picks</a> <a href="#vcds.Patch">Patch</a> 
<br>
<b>Functions</b> <ul>
  <li><a id="vcds.normalize" href="#vcds.normalize" class=anchor><b>fn normalize</b></a><span class=code>(s) -&gt; ds.squash(ds.trimEnd(s))</span><br>
  
  normalize a line for comparing (anchoring).
  This just squashes and trims the end.</li>
  <li><a id="vcds.apply" href="#vcds.apply" class=anchor><b>fn apply</b></a><span class=code>(base, changes, out--[[{}]]) -&gt; out</span><br>
  
  Apply changes to base (TableLines), push to <span class=code>out</span></li>
  <li><a id="vcds.toChanges" href="#vcds.toChanges" class=anchor><b>fn toChanges</b></a><span class=code>(diffs, full)</span></li>
  <li><a id="vcds.toDiffs" href="#vcds.toDiffs" class=anchor><b>fn toDiffs</b></a><span class=code>(base, changes) -&gt; diffs</span><br>
  
  Convert Changes to Diffs with full context</li>
  <li><a id="vcds.createAnchorTop" href="#vcds.createAnchorTop" class=anchor><b>fn createAnchorTop</b></a><span class=code>(base, l, aLen)</span></li>
  <li><a id="vcds.createAnchorBot" href="#vcds.createAnchorBot" class=anchor><b>fn createAnchorBot</b></a><span class=code>(base, l, aLen)</span></li>
  <li><a id="vcds.findAnchor" href="#vcds.findAnchor" class=anchor><b>fn findAnchor</b></a><span class=code>(base, baseMap, anchors, above--[[false]]) -&gt; (l, c)</span><br>
  
  Find the actual anchor by searching for uniqueness in the anchors <ul>
    <li>above=true:  find above (search up)</li>
    <li>above=false: find below (search down)</li>
  </ul></li>
  <li><a id="vcds.pickAnchorsTop" href="#vcds.pickAnchorsTop" class=anchor><b>fn pickAnchorsTop</b></a><span class=code>(pick) -&gt; isStartOfFile, anchors</span></li>
  <li><a id="vcds.pickAnchorsBot" href="#vcds.pickAnchorsBot" class=anchor><b>fn pickAnchorsBot</b></a><span class=code>(base, pick) -&gt; isEndOfFile, anchors</span></li>
  <li><a id="vcds.createPatch" href="#vcds.createPatch" class=anchor><b>fn createPatch</b></a><span class=code>(base, baseMap, pick)</span><br>
  
  Create a patch item from a pick
  
  At it's most basic it would just be: <ul>
    <li>find line position via top and/or bottom anchor. We want at least 2 lines</li>
    <li>convert pick to change. Walk the text applying the change.</li>
  </ul>
  
  There are some strategies to fix common anchor misses: <ul>
    <li>If an anchor is missing, the nearby change can be used instead. Use either
    the removed or added lines. For instance, if we are supposed to remove lines
    then try and find them. Conversely if the patch was already applied then the
    supposed-to-be added lines will already be there!</li>
    <li>When adding, existing identical text is okay.</li>
    <li>When removing, missing text is okay as long as it's followed by an anchor of
    some kind</li>
    <li>Keep lines act as an anchor (for above) but are otherwise not required - they
    are "free" to change or be removed. If they are missing then the algorithm will
    try to continue the change with or without them (dynamic programming)</li>
    <li>empty lines are entirely ignored and are not considered an anchor</li>
  </ul></li>
</ul>
<br>
<h4><a id="vcds.Diff" href="#vcds.Diff" class=anchor>Record Diff</h4></a>
Single Line Diff
This type is good for displaying differences to a user.
<b>Fields:</b><ul>
  <li><a id="vcds.Diff.b" href="#vcds.Diff.b" class=anchor><b>.b</b></a>
  (base)   orig file.  '+'=added</li>
  <li><a id="vcds.Diff.c" href="#vcds.Diff.c" class=anchor><b>.c</b></a>
  (change) new file.   '-'=removed</li>
  <li><a id="vcds.Diff.text" href="#vcds.Diff.text" class=anchor><b>.text</b></a></li>
</ul>
<b>Methods</b> <ul>
  <li><a id="Diff.isKeep" href="#Diff.isKeep" class=anchor><b>fn isKeep</b></a><span class=code>(d)</span></li>
</ul>
<br>
<h4><a id="vcds.Keep" href="#vcds.Keep" class=anchor>Record Keep</h4></a>
<b>Fields:</b><ul>
  <li><a id="vcds.Keep.num" href="#vcds.Keep.num" class=anchor><b>.num</b></a></li>
</ul>
<b>Methods</b> <ul>
  <li><a id="Keep.len" href="#Keep.len" class=anchor><b>fn len</b></a><span class=code>(k) -&gt; k.num and k.num or #k</span></li>
</ul>
<br>
<h4><a id="vcds.Change" href="#vcds.Change" class=anchor>Record Change</h4></a>
<b>Fields:</b><ul>
  <li><a id="vcds.Change.rem" href="#vcds.Change.rem" class=anchor><b>.rem</b></a>
  removed lines</li>
  <li><a id="vcds.Change.add" href="#vcds.Change.add" class=anchor><b>.add</b></a>
  text to add</li>
</ul>
<b>Methods</b> <ul>
  <li><a id="Change.len" href="#Change.len" class=anchor><b>fn len</b></a><span class=code>(ch)</span></li>
</ul>
<br>
<h4><a id="vcds.DiffsExtender" href="#vcds.DiffsExtender" class=anchor>Record DiffsExtender</h4></a>
<b>Fields:</b><ul>
  <li><a id="vcds.DiffsExtender.diffs" href="#vcds.DiffsExtender.diffs" class=anchor><b>.diffs</b></a></li>
  <li><a id="vcds.DiffsExtender.base" href="#vcds.DiffsExtender.base" class=anchor><b>.base</b></a></li>
  <li><a id="vcds.DiffsExtender.bl" href="#vcds.DiffsExtender.bl" class=anchor><b>.bl</b></a>
  base line</li>
  <li><a id="vcds.DiffsExtender.cl" href="#vcds.DiffsExtender.cl" class=anchor><b>.cl</b></a>
  change line</li>
</ul>
<br>
<h4><a id="vcds.Picks" href="#vcds.Picks" class=anchor>Record Picks</h4></a>
Create picks (aka cherry picks) iterator from changes.
These can then be applied to a new base using vcds.patch(base, picks)
<br>
Each "pick" is a list of Diffs which are anchored by the lines
above and below (unless they are start/end of file).
<b>Fields:</b><ul>
  <li><a id="vcds.Picks.changes" href="#vcds.Picks.changes" class=anchor><b>.changes</b></a>
  list of changes</li>
  <li><a id="vcds.Picks.ci" href="#vcds.Picks.ci" class=anchor><b>.ci</b></a>
  for iterating</li>
  <li><a id="vcds.Picks.de" href="#vcds.Picks.de" class=anchor><b>.de</b></a></li>
  <li><a id="vcds.Picks.set" href="#vcds.Picks.set" class=anchor><b>.set</b></a>
  settings (need refactor)</li>
</ul>
<b>Methods</b> <ul>
  <li><a id="Picks.groupChanges" href="#Picks.groupChanges" class=anchor><b>fn groupChanges</b></a><span class=code>(p, ci)</span><br>
  
  Get which changes to include in a patch group.
  A group is a series of patches with Keep:len() < anchorLen (default=3)
  between them.</li>
</ul>
<br>
<h4><a id="vcds.Patch" href="#vcds.Patch" class=anchor>Record Patch</h4></a>
<b>Fields:</b><ul>
  <li><a id="vcds.Patch.conflict" href="#vcds.Patch.conflict" class=anchor><b>.conflict</b></a></li>
  <li><a id="vcds.Patch.bl" href="#vcds.Patch.bl" class=anchor><b>.bl</b></a></li>
</ul>
<br>
</div></body>
</html>
