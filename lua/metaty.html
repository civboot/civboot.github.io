<head>
  <meta charset="utf-8">
  <title>Civboot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../styles.css">
</head>
<nav>
  <ul>
    <a href="../index.html"   class="nav"             >civ/</a>
    <a href="index.html"      class="nav nav-selected">lua/</a>
  </ul>
</nav>

<!DOCTYPE html>
<html>
<body><div class=doc>
simple but effective Lua type system using metatables
<br>
Metatype is a library and specification for creating performant, documented, and
typo-safe Lua record-types which can be formatted.
<br>
<div class=info> Turn off typo checking by setting the global <span class=code>LUA_OPT=3</span> or higher.</div>
<br>
<div class=code-block>local G = G or _G<br>
--- module documentation<br>
local M = G.mod and mod'myMod' or {} -- (see pkg)<br>
<br>
local mty = require'metaty'<br>
<br>
-- Documentation for Pos (position)<br>
M.Pos = mty'Pos' {<br>
&nbsp; 'x[int]: x coordinate',<br>
&nbsp; 'y[int]: y coordinate', y = 0,<br>
}<br>
<br>
local p1 = Pos{x=4}<br>
local p1 = Pos{x=4, y=3, z=5} -- error if checking turned on
</div>
<br>
The above expands to the following. Note that the "typosafe" elements
are removed when <span class=code>LUA_OPT &gt; 3</span>
<div class=code-block>local M = {}<br>
local metaty = require'metaty'<br>
<br>
local Pos = setmetatable({<br>
&nbsp; __name='Pos',<br>
&nbsp; y = 0,<br>
&nbsp; -- used with metaty.Fmt and help()<br>
&nbsp; __fields={'x', 'y', x='[int]', y='[int]'},<br>
&nbsp; __newindex = metaty.newindex, -- typosafe setting<br>
}, {<br>
&nbsp; __call = function(T, t)<br>
&nbsp; &nbsp; metaty.fieldsCheck(T.__fields, t) -- typosafe constructor<br>
&nbsp; &nbsp; return setmetatable(t, T)<br>
&nbsp; end,<br>
&nbsp; __index = metaty.index, -- typosafe getting<br>
})<br>
Pos.__index = Pos<br>
<br>
-- `mod` gives documentation reflection<br>
PKG_LOCS[M.myFn] &nbsp; &nbsp; &nbsp; &nbsp; = 'path/to/file.lua:123'<br>
PKG_NAMES[M.myFn] &nbsp; &nbsp; &nbsp; &nbsp;= 'mymod.Pos'<br>
PKG_LOOKUP['myMod.Pos'] = M.Pos
</div>
<br>
<h3><a id="metaty-API" href="#metaty-API" class=anchor>API</h3></a> <ul>
  <li><span class=code>ty(v)</span> return the metaty of <span class=code>v</span>. For tables this is <span class=code>getmetatable(v)</span>,
  else it is <span class=code>type(v)</span>.</li>
  <li><span class=code>metaty'name' {'field1[type] documentation', 'field2[type]'}</span>
  creates a documented and typo-safe record type (see examples) <ul>
    <li>the <span class=code>[type</span></li>
  </ul> field can also be in the form <span class=code>{type}</span> for a list
  of the type or <span class=code>{string: type}</span> for a map of the type.</li>
  <li><span class=code>@&lt;decimal&gt;</span> (i.e. <span class=code>@2</span>) can be put after the type to specify the
  decimal value to use for the field when de/serializing.
  <br>
  It is recommended that once you assign a field to a decimal value to
  never change it if there is any chance it is stored or being used
  by an RPC service/etc with the previous version.</li>
</ul>
</div></body>
</html>
